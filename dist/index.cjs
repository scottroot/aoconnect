"use strict";var Er=Object.create;var ie=Object.defineProperty;var Ir=Object.getOwnPropertyDescriptor;var Pr=Object.getOwnPropertyNames;var Ur=Object.getPrototypeOf,Fr=Object.prototype.hasOwnProperty;var Cr=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),wt=(r,e)=>{for(var t in e)ie(r,t,{get:e[t],enumerable:!0})},vt=(r,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Pr(e))!Fr.call(r,n)&&n!==t&&ie(r,n,{get:()=>e[n],enumerable:!(o=Ir(e,n))||o.enumerable});return r};var ue=(r,e,t)=>(t=r!=null?Er(Ur(r)):{},vt(e||!r||!r.__esModule?ie(t,"default",{value:r,enumerable:!0}):t,r)),Dr=r=>vt(ie({},"__esModule",{value:!0}),r);var Rr=Cr((xl,Ar)=>{"use strict";Ar.exports={}});var Mn={};wt(Mn,{assign:()=>Rn,connect:()=>dt,createDataItemSigner:()=>Tn,dryrun:()=>An,message:()=>wn,monitor:()=>Sn,result:()=>yn,results:()=>xn,serializeCron:()=>gt,spawn:()=>vn,unmonitor:()=>_n});module.exports=Dr(Mn);var le=class{fetch;MU_URL;logger;constructor({fetch:e,MU_URL:t,logger:o}){this.fetch=e,this.MU_URL=t,this.logger=o.child("deployMessage")}async execute(e){try{let{processId:t,data:o,tags:n,anchor:s,signer:a}=e,u=await a({data:o,tags:n,target:t,anchor:s});this.logger.tap("Signing data")({processId:t,data:o,tags:n,anchor:s});let l=await this.fetch(this.MU_URL,{method:"POST",headers:{"Content-Type":"application/octet-stream",Accept:"application/json"},redirect:"follow",body:u.raw});if(!l.ok){let f=await l.text();throw this.logger.tap("Error encountered when writing message via MU")(f),new Error(`Error while communicating with MU: ${l.status}: ${f}`)}let c=await l.json();return this.logger.tap("Successfully wrote message via MU")(c),{messageId:u.id}}catch(t){throw this.logger.tap("Error")(t),t}}},ce=class{fetch;MU_URL;logger;constructor({fetch:e,MU_URL:t,logger:o}){this.fetch=e,this.MU_URL=t,this.logger=o.child("deployProcess")}async execute(e){try{let{data:t,tags:o,signer:n}=e,s=await n({data:t,tags:o});this.logger.tap("Signing data")({data:t,tags:o});let a=await this.fetch(this.MU_URL,{method:"POST",headers:{"Content-Type":"application/octet-stream",Accept:"application/json"},redirect:"follow",body:s.raw});if(!a.ok){let l=await a.text();throw this.logger.tap("Error encountered when deploying process via MU")(l),new Error(`Error while communicating with MU: ${a.status}: ${l}`)}let u=await a.json();return this.logger.tap("Successfully deployed process via MU")(u),{processId:s.id}}catch(t){throw this.logger.tap("Error")(t),t}}},fe=class{fetch;MU_URL;logger;constructor({fetch:e,MU_URL:t,logger:o}){this.fetch=e,this.MU_URL=t,this.logger=o.child("deployMonitor")}async execute(e){try{let{processId:t,data:o,tags:n,anchor:s,signer:a}=e,u=await a({data:o,tags:n,target:t,anchor:s});this.logger.tap("Signing data")({processId:t,data:o,tags:n,anchor:s});let l=await this.fetch(`${this.MU_URL}/monitor/${t}`,{method:"POST",headers:{"Content-Type":"application/octet-stream",Accept:"application/json"},redirect:"follow",body:u.raw});if(!l.ok){let f=await l.text();throw this.logger.tap("Error encountered when subscribing to process via MU")(f),new Error(`Error while communicating with MU: ${l.status}: ${f}`)}let c={ok:!0};return this.logger.tap("Successfully subscribed to process via MU")(c),{messageId:u.id}}catch(t){throw this.logger.tap("Error")(t),t}}},pe=class{fetch;MU_URL;logger;constructor({fetch:e,MU_URL:t,logger:o}){this.fetch=e,this.MU_URL=t,this.logger=o.child("deployUnmonitor")}async execute(e){try{let{processId:t,data:o,tags:n,anchor:s,signer:a}=e,u=await a({data:o,tags:n,target:t,anchor:s});this.logger.tap("Signing data")({processId:t,data:o,tags:n,anchor:s});let l=await this.fetch(`${this.MU_URL}/monitor/${t}`,{method:"DELETE",headers:{"Content-Type":"application/octet-stream",Accept:"application/json"},redirect:"follow",body:u.raw});if(!l.ok){let f=await l.text();throw this.logger.tap("Error encountered when unsubscribing to process via MU")(f),new Error(`Error while communicating with MU: ${l.status}: ${f}`)}let c={ok:!0};return this.logger.tap("Successfully unsubscribed to process via MU")(c),{messageId:u.id}}catch(t){throw this.logger.tap("Error")(t),t}}},me=class{fetch;MU_URL;logger;constructor({fetch:e,MU_URL:t,logger:o}){this.fetch=e,this.MU_URL=t,this.logger=o.child("deployAssign")}async execute(e){try{let{process:t,message:o,baseLayer:n,exclude:s}=e,a=n?"&base-layer":"",u=s?"&exclude="+s.join(","):"",l=[this.MU_URL,"?",`process-id=${t}`,"&",`assign=${o}`,a,u].join(""),c=await this.fetch(l,{method:"POST",headers:{"Content-Type":"application/octet-stream",Accept:"application/json"}});if(!c.ok){let p=await c.text();throw this.logger.tap("Error encountered when writing assignment via MU")(p),new Error(`Error while communicating with MU: ${c.status}: ${p}`)}let f=await c.json();return this.logger.tap("Successfully wrote assignment via MU")(f),{assignmentId:f.id}}catch(t){throw this.logger.tap("Error")(t),t}}};var ge=class{fetch;CU_URL;logger;constructor({fetch:e,CU_URL:t,logger:o}){this.fetch=e,this.CU_URL=t,this.logger=o}async execute(e){return this.logger.tap("posting dryrun request to CU")(e),await(await this.fetch(`${this.CU_URL}/dry-run?process-id=${e.Target}`,{method:"POST",headers:{"Content-Type":"application/json"},redirect:"follow",body:JSON.stringify(e)})).json()}},de=class{fetch;CU_URL;logger;constructor({fetch:e,CU_URL:t,logger:o}){this.fetch=e,this.CU_URL=t,this.logger=o}async execute({id:e,processId:t}){let o=`${this.CU_URL}/result/${e}?process-id=${t}`;return this.logger.tap("fetching message result from CU")(o),await(await this.fetch(o,{method:"GET",headers:{Accept:"application/json"},redirect:"follow"})).json()}},he=class{fetch;CU_URL;logger;constructor({fetch:e,CU_URL:t,logger:o}){this.fetch=e,this.CU_URL=t,this.logger=o}async execute({process:e,from:t,to:o,sort:n,limit:s}){let a=new URL(`${this.CU_URL}/results/${e}`),u=new URLSearchParams(a.search);return t&&u.append("from",t),o&&u.append("to",o),n&&u.append("sort",n),s&&u.append("limit",s.toString()),a.search=u.toString(),this.logger.tap("fetching message result from CU")(a.toString()),await(await this.fetch(a.toString(),{method:"GET",headers:{Accept:"application/json"},redirect:"follow"})).json()}};var We=ue(require("mnemonist/lru-map.js"),1),ye,St=({MAX_SIZE:r})=>ye||(ye=new We.default(r),ye),B=class{logger;fetch;cache;constructor({logger:e,fetch:t,cache:o=new We.default(100)}){this.logger=e,this.fetch=t,this.cache=o}async execute({suUrl:e,processId:t}){if(this.cache.has(t))return this.cache.get(t);try{let o=await this.fetch(`${e}/processes/${t}`,{method:"GET",redirect:"follow"});if(!o.ok)throw this.logger("Error Encountered when fetching process meta from SU '%s' for process '%s'",e,t),new Error(`Encountered Error fetching scheduled messages from Scheduler Unit: ${o.status}: ${await o.text()}`);let n=await o.json();return this.logger("Caching process meta for process '%s'",t),this.cache.set(t,{tags:n.tags}),n}catch(o){throw this.logger("Error: %s",o.message),o}}};var j=require("zod");var $=require("zod"),_t=({url:r,path:e})=>{if(!e)return r;e.startsWith("/")&&(e=e.slice(1));let t=new URL(r);return t.pathname=t.pathname.replace(/\/$/,"")+"/"+e,t.toString()};function At(r=[]){let e=r.reduce((t,o)=>(t[o.name]||(t[o.name]=[]),t[o.name].push(o.value),t),{});return Object.entries(e).reduce((t,[o,n])=>(t[o]=n.length>1?n:[n[0]],t),{})}function V(r,{name:e,value:t}){return r.filter(o=>o.name!==e?!0:t!==void 0?o.value!==t:!1)}function ze(r,e){return typeof r=="string"?r===e:Array.isArray(r)?r.includes(e):!1}function zr(r){return r instanceof $.ZodError}function R(r){let e;return zr(r)?(e=new Error(qr(r)),e.stack=(e.stack||"")+`
`+(r.stack||"")):r instanceof Error?e=r:r&&typeof r=="object"&&"message"in r?e=new Error(r.message):typeof r=="string"?e=new Error(r):e=new Error("An error occurred"),e}function xe(r,e,t){return r.issues.reduce((o,n)=>{switch(n.code){case $.ZodIssueCode.invalid_arguments:return o.concat(xe(n.argumentsError,422,"Invalid Arguments"));case $.ZodIssueCode.invalid_return_type:return o.concat(xe(n.returnTypeError,500,"Invalid Return"));case $.ZodIssueCode.invalid_union:return o.concat(n.unionErrors.flatMap(s=>xe(s,400,"Invalid Union")));default:return o.concat({...n,status:e,contextCode:t})}},[])}function qr(r){return xe(r,400,"").reduce((o,n)=>{let{message:s,path:a,contextCode:u}=n,l=a[1]||a[0],c=u?`${u} `:"";return o.push(`${c}'${l}': ${s}.`),o},[]).join(" | ")}var Gr=j.z.object({data:j.z.object({transactions:j.z.object({edges:j.z.array(j.z.object({node:j.z.record(j.z.any())}))})})}),we=class{logger;fetch;GRAPHQL_URL;query_template;constructor({logger:e,fetch:t,GRAPHQL_URL:o}){this.logger=e,this.fetch=t,this.GRAPHQL_URL=o,this.query_template=`
    query GetTransactions ($transactionIds: [ID!]!) {
      transactions(ids: $transactionIds) {
        edges {
          node {
            owner {
              address
            }
            tags {
              name
              value
            }
            block {
              id
              height
              timestamp
            }
          }
        }
      }
    }`}async execute(e){try{let t=await this.fetch(this.GRAPHQL_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:this.query_template,variables:{transactionIds:[e]}})});if(!t.ok)throw this.logger('Error Encountered when querying gateway for transaction "%s"',e),new Error(`${t.status}: ${await t.text()}`);let o=await t.json();return Gr.parse(o).data.transactions.edges[0].node}catch(t){throw this.logger("Error: %s",t.message),R(t)}}};var Rt=ue(require("debug"),1),qe=(r="aoconnect-ts")=>{let e=(0,Rt.default)(r);return e.child=t=>qe(`${e.namespace}:${t}`),e.tap=(t,...o)=>n=>(e(t,...o,n),n),e};var Se=require("zod");var i=require("zod"),F=i.z.object({name:i.z.string(),value:i.z.string()}),Pn=i.z.array(F),I=i.z.function().args(i.z.object({data:i.z.any(),tags:i.z.array(F),target:i.z.string().optional(),anchor:i.z.string().optional()})).returns(i.z.promise(i.z.object({id:i.z.string(),raw:i.z.any()}))),Tt=i.z.function().args(i.z.object({Id:i.z.string(),Target:i.z.string(),Owner:i.z.string(),Anchor:i.z.string().optional(),Data:i.z.any().default("1234"),Tags:i.z.array(i.z.object({name:i.z.string(),value:i.z.string()}))})).returns(i.z.promise(i.z.any())),Mt=i.z.function().args(i.z.object({id:i.z.string().min(1,{message:"message id is required"}),processId:i.z.string().min(1,{message:"process id is required"})})).returns(i.z.promise(i.z.any())),Un=i.z.function().args(i.z.object({process:i.z.string().min(1,{message:"process id is required"}),from:i.z.string().optional(),to:i.z.string().optional(),sort:i.z.enum(["ASC","DESC"]).default("ASC"),limit:i.z.number().optional()})).returns(i.z.promise(i.z.object({edges:i.z.array(i.z.object({cursor:i.z.string(),node:i.z.object({Output:i.z.any().optional(),Messages:i.z.array(i.z.any()).optional(),Spawns:i.z.array(i.z.any()).optional(),Error:i.z.any().optional()})}))}))),Ge=i.z.function().args(i.z.object({processId:i.z.string(),data:i.z.any(),tags:i.z.array(F),anchor:i.z.string().optional(),signer:I})).returns(i.z.promise(i.z.object({messageId:i.z.string()}).passthrough())),bt=i.z.function().args(i.z.object({data:i.z.any(),tags:i.z.array(F),signer:I})).returns(i.z.promise(i.z.object({processId:i.z.string()}).passthrough())),Lt=i.z.function().args(i.z.object({process:i.z.string(),message:i.z.string(),baseLayer:i.z.boolean().optional(),exclude:i.z.array(i.z.string()).optional()})).returns(i.z.promise(i.z.object({assignmentId:i.z.string()}).passthrough())),ve=Ge,Fn=i.z.function().args(i.z.object({suUrl:i.z.string().url(),processId:i.z.string()})).returns(i.z.promise(i.z.object({tags:i.z.array(F)}).passthrough())),Cn=i.z.function().args(i.z.string()).returns(i.z.promise(i.z.object({url:i.z.string()}))),Et=i.z.function().args(i.z.string()).returns(i.z.promise(i.z.boolean())),It=i.z.function().args(i.z.string()).returns(i.z.promise(i.z.object({tags:i.z.array(F)}).passthrough()));async function Pt({loadResult:r},e){return Mt.implement(r)(e)}var kr=Se.z.object({id:Se.z.string().min(1,{message:"message is required to be a message id"}),processId:Se.z.string().min(1,{message:"process is required to be a process id"})});function Ut(r){return async e=>{try{console.log(`getResult, args = ${JSON.stringify(e)}`);let t={id:e.message,processId:e.process};kr.parse(t);let o=await Pt(r,t);return r.logger.tap('readResult result for message "%s": %O',o),o}catch(t){throw R(t)}}}function Ft(r){let{tags:e,...t}=r,n=[{name:"Data-Protocol",value:"ao"},{name:"Variant"},{name:"Type"},{name:"SDK"}].reduce((s,a)=>V(s,a),e||[]);return n=[...n,{name:"Data-Protocol",value:"ao"},{name:"Variant",value:"ao.TN.1"},{name:"Type",value:"Message"},{name:"SDK",value:"aoconnect"}],n=n.map(s=>F.parse(s)),{...t,tags:n}}function Ct(r,e){if(r.data)return r;let{data:t,tags:o,...n}=r,s=Math.random().toString().slice(-4),a=V(o,{name:"Content-Type"});return a.push({name:"Content-Type",value:"text/plain"}),e.tap('added pseudo-random string as message "data"'),{...n,data:s,tags:a}}function Dt(r){let e=Ge.implement(r.deployMessage);return async t=>{try{let{process:o,signer:n,...s}=t;if(!o)throw"Missing process id";let a=I.implement(n),u=Ft(s),c={...Ct(u,r.logger),processId:o,signer:I.implement(a)},f=await e(c),p={...t,messageId:f.messageId};return r.logger.tap('Deploy message result for process "%s": %O',o)(p),f}catch(o){throw R(o)}}}async function Br({loadTransactionMeta:r,logger:e,module:t}){try{let n=await It.implement(r)(t),s=At(n.tags);if(!ze(s["Data-Protocol"],"ao"))throw"Tag 'Data-Protocol': value 'ao' was not found on module";if(!ze(s.Type,"Module"))throw"Tag 'Data-Protocol': value 'Module' was not found on module";if(!s["Module-Format"])throw"Tag 'Module-Format': was not found on module";if(!s["Input-Encoding"])throw"Tag 'Input-Encoding': was not found on module";if(!s["Output-Encoding"])throw"Tag 'Output-Encoding': was not found on module";return e.tap("Verified module source"),!0}catch(o){return e.tap(`Verifying module source failed: ${o}`),!1}}async function $r({logger:r,validateScheduler:e,scheduler:t}){try{return await Et.implement(e)(t)?(r.tap("Verified scheduler"),!0):(r.tap(`Verifying scheduler failed: Valid Scheduler-Location owned by ${t} not found`),!1)}catch(o){return r.tap(`Verifying scheduler failed: ${o}`),!1}}function Vr({signer:r,logger:e}){return r?!0:(e.tap("signer not found"),!1)}async function Ot(r,e){let t=r.logger.child("verifyInput");return await Br({loadTransactionMeta:r.loadTransactionMeta,module:e.module,logger:t})?await $r({validateScheduler:r.validateScheduler,scheduler:e.scheduler,logger:t})?Vr({signer:e.signer,logger:t})?(t.tap("Successfully verified inputs"),!0):(t.tap("Failed to validate signer."),!1):(t.tap("Failed to validate scheduler."),!1):(t.tap("Failed to validate module."),!1)}function Hr({tags:r,module:e,scheduler:t}){let o=[{name:"Data-Protocol",value:"ao"},{name:"Variant"},{name:"Type"},{name:"Module"},{name:"Scheduler"},{name:"SDK"}],n=r||[],s=o.reduce((a,u)=>V(a,u),n);return s=[...s,{name:"Data-Protocol",value:"ao"},{name:"Variant",value:"ao.TN.1"},{name:"Type",value:"Process"},{name:"Module",value:e},{name:"Scheduler",value:t},{name:"SDK",value:"aoconnect"}],s.map(a=>F.parse(a))}function Qr(r,e){if(!r.tags)throw"No tags present when building data for spawn.";if(r.data)return{data:r.data,tags:r.tags};let{tags:t,...o}=r,n=Math.random().toString().slice(-4),s=V(t,{name:"Content-Type"});return s.push({name:"Content-Type",value:"text/plain"}),e.tap('added pseudo-random string as message "data"'),{...o,data:n,tags:s}}async function jt(r,e){let t=r.logger.child("uploadProcess"),{data:o,tags:n}=Qr(e,t),s=Hr({...e,tags:n});return await bt.implement(r.deployProcess)({data:o,tags:s,signer:I.implement(e.signer)})}function Wt(r){return async e=>{try{if(!await Ot(r,e))throw"Invalid inputs";return await jt(r,e)}catch(t){throw R(t)}}}async function zt(r,e){return{monitorId:(await ve.implement(r.deployMonitor)({processId:e.process,signer:I.implement(e.signer),data:Math.random().toString().slice(-4),tags:[]})).messageId}}function qt(r){return async e=>{try{return await zt(r,e)}catch(t){throw R(t)}}}async function Gt(r,e){return{monitorId:(await ve.implement(r.deployUnmonitor)({processId:e.process,signer:I.implement(e.signer),data:Math.random().toString().slice(-4),tags:[]})).messageId}}function Nt(r){return async e=>{try{return await Gt(r,e)}catch(t){throw R(t)}}}var P=require("zod"),Xr=P.z.object({Id:P.z.string(),Target:P.z.string(),Owner:P.z.string(),Anchor:P.z.string().optional(),Data:P.z.any().default("1234"),Tags:P.z.array(P.z.object({name:P.z.string(),value:P.z.string()}))});function kt(r){let e=Xr.parse(r),t=[...e.Tags.map(o=>o),{name:"Data-Protocol",value:"ao"},{name:"Type",value:"Message"},{name:"Variant",value:"ao.TN.1"}];return{Id:e.Id,Target:e.Target,Owner:e.Owner,Anchor:e.Anchor??"ABCD",Data:e.Data??Math.random().toString().slice(-4),Tags:t}}function Jr({process:r,data:e,tags:t,anchor:o,...n}){return{Id:"1234",Owner:"1234",...n,Target:r,Data:e??"1234",Tags:t??[],Anchor:o??"0"}}function Bt(r){let e=Tt.implement(r.dryrunFetch);return async t=>{try{let o=Jr(t),n=kt(o);return await e(n)}catch(o){throw R(o)}}}async function $t(r,e){return{assignmentId:(await Lt.implement(r.deployAssign)({process:e.process,message:e.message,baseLayer:e.baseLayer,exclude:e.exclude})).assignmentId}}function Vt(r){return async e=>{try{return await $t(r,e)}catch(t){throw R(t)}}}var _=require("zod");var Ht=_.z.object({process:_.z.string().min(1,{message:"process identifier is required"}),from:_.z.string().optional(),to:_.z.string().optional(),sort:_.z.enum(["ASC","DESC"]).default("ASC"),limit:_.z.number().optional()}),Kr=_.z.object({edges:_.z.array(_.z.object({cursor:_.z.string(),node:_.z.object({Output:_.z.any().optional(),Messages:_.z.array(_.z.any()).optional(),Spawns:_.z.array(_.z.any()).optional(),Error:_.z.any().optional()})}))}),Zr=_.z.function().args(Ht).returns(_.z.promise(Kr));function Qt(r){return async function(e){try{let t=Ht.parse(e),n=await Zr.implement(r.queryResults)(t);return r.logger.tap('readResults result for message "%s": %O',e.process)(n),n}catch(t){throw R(t)}}}function y(r){return r!=null&&typeof r=="object"&&r["@@functional/placeholder"]===!0}function w(r){return function e(t){return arguments.length===0||y(t)?e:r.apply(this,arguments)}}function m(r){return function e(t,o){switch(arguments.length){case 0:return e;case 1:return y(t)?e:w(function(n){return r(t,n)});default:return y(t)&&y(o)?e:y(t)?w(function(n){return r(n,o)}):y(o)?w(function(n){return r(t,n)}):r(t,o)}}}function D(r,e){switch(r){case 0:return function(){return e.apply(this,arguments)};case 1:return function(t){return e.apply(this,arguments)};case 2:return function(t,o){return e.apply(this,arguments)};case 3:return function(t,o,n){return e.apply(this,arguments)};case 4:return function(t,o,n,s){return e.apply(this,arguments)};case 5:return function(t,o,n,s,a){return e.apply(this,arguments)};case 6:return function(t,o,n,s,a,u){return e.apply(this,arguments)};case 7:return function(t,o,n,s,a,u,l){return e.apply(this,arguments)};case 8:return function(t,o,n,s,a,u,l,c){return e.apply(this,arguments)};case 9:return function(t,o,n,s,a,u,l,c,f){return e.apply(this,arguments)};case 10:return function(t,o,n,s,a,u,l,c,f,p){return e.apply(this,arguments)};default:throw new Error("First argument to _arity must be a non-negative integer no greater than ten")}}function _e(r,e,t){return function(){for(var o=[],n=0,s=r,a=0,u=!1;a<e.length||n<arguments.length;){var l;a<e.length&&(!y(e[a])||n>=arguments.length)?l=e[a]:(l=arguments[n],n+=1),o[a]=l,y(l)?u=!0:s-=1,a+=1}return!u&&s<=0?t.apply(this,o):D(Math.max(0,s),_e(r,o,t))}}var Yr=m(function(e,t){return e===1?w(t):D(e,_e(e,[],t))}),Ae=Yr;function N(r){return function e(t,o,n){switch(arguments.length){case 0:return e;case 1:return y(t)?e:m(function(s,a){return r(t,s,a)});case 2:return y(t)&&y(o)?e:y(t)?m(function(s,a){return r(s,o,a)}):y(o)?m(function(s,a){return r(t,s,a)}):w(function(s){return r(t,o,s)});default:return y(t)&&y(o)&&y(n)?e:y(t)&&y(o)?m(function(s,a){return r(s,a,n)}):y(t)&&y(n)?m(function(s,a){return r(s,o,a)}):y(o)&&y(n)?m(function(s,a){return r(t,s,a)}):y(t)?w(function(s){return r(s,o,n)}):y(o)?w(function(s){return r(t,s,n)}):y(n)?w(function(s){return r(t,o,s)}):r(t,o,n)}}}var H=Array.isArray||function(e){return e!=null&&e.length>=0&&Object.prototype.toString.call(e)==="[object Array]"};function Ne(r){return r!=null&&typeof r["@@transducer/step"]=="function"}function k(r,e,t){return function(){if(arguments.length===0)return t();var o=arguments[arguments.length-1];if(!H(o)){for(var n=0;n<r.length;){if(typeof o[r[n]]=="function")return o[r[n]].apply(o,Array.prototype.slice.call(arguments,0,-1));n+=1}if(Ne(o)){var s=e.apply(null,Array.prototype.slice.call(arguments,0,-1));return s(o)}}return t.apply(this,arguments)}}function ke(r){return r&&r["@@transducer/reduced"]?r:{"@@transducer/value":r,"@@transducer/reduced":!0}}var W={init:function(){return this.xf["@@transducer/init"]()},result:function(r){return this.xf["@@transducer/result"](r)}};function Re(r){for(var e=[],t;!(t=r.next()).done;)e.push(t.value);return e}function Te(r,e,t){for(var o=0,n=t.length;o<n;){if(r(e,t[o]))return!0;o+=1}return!1}function Be(r){var e=String(r).match(/^function (\w*)/);return e==null?"":e[1]}function z(r,e){return Object.prototype.hasOwnProperty.call(e,r)}function eo(r,e){return r===e?r!==0||1/r===1/e:r!==r&&e!==e}var Me=typeof Object.is=="function"?Object.is:eo;var Xt=Object.prototype.toString,to=function(){return Xt.call(arguments)==="[object Arguments]"?function(e){return Xt.call(e)==="[object Arguments]"}:function(e){return z("callee",e)}}(),Jt=to;var ro=!{toString:null}.propertyIsEnumerable("toString"),Kt=["constructor","valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],Zt=function(){"use strict";return arguments.propertyIsEnumerable("length")}(),oo=function(e,t){for(var o=0;o<e.length;){if(e[o]===t)return!0;o+=1}return!1},no=typeof Object.keys=="function"&&!Zt?w(function(e){return Object(e)!==e?[]:Object.keys(e)}):w(function(e){if(Object(e)!==e)return[];var t,o,n=[],s=Zt&&Jt(e);for(t in e)z(t,e)&&(!s||t!=="length")&&(n[n.length]=t);if(ro)for(o=Kt.length-1;o>=0;)t=Kt[o],z(t,e)&&!oo(n,t)&&(n[n.length]=t),o-=1;return n}),C=no;var so=w(function(e){return e===null?"Null":e===void 0?"Undefined":Object.prototype.toString.call(e).slice(8,-1)}),$e=so;function Yt(r,e,t,o){var n=Re(r),s=Re(e);function a(u,l){return Z(u,l,t.slice(),o.slice())}return!Te(function(u,l){return!Te(a,l,u)},s,n)}function Z(r,e,t,o){if(Me(r,e))return!0;var n=$e(r);if(n!==$e(e))return!1;if(typeof r["fantasy-land/equals"]=="function"||typeof e["fantasy-land/equals"]=="function")return typeof r["fantasy-land/equals"]=="function"&&r["fantasy-land/equals"](e)&&typeof e["fantasy-land/equals"]=="function"&&e["fantasy-land/equals"](r);if(typeof r.equals=="function"||typeof e.equals=="function")return typeof r.equals=="function"&&r.equals(e)&&typeof e.equals=="function"&&e.equals(r);switch(n){case"Arguments":case"Array":case"Object":if(typeof r.constructor=="function"&&Be(r.constructor)==="Promise")return r===e;break;case"Boolean":case"Number":case"String":if(!(typeof r==typeof e&&Me(r.valueOf(),e.valueOf())))return!1;break;case"Date":if(!Me(r.valueOf(),e.valueOf()))return!1;break;case"Error":return r.name===e.name&&r.message===e.message;case"RegExp":if(!(r.source===e.source&&r.global===e.global&&r.ignoreCase===e.ignoreCase&&r.multiline===e.multiline&&r.sticky===e.sticky&&r.unicode===e.unicode))return!1;break}for(var s=t.length-1;s>=0;){if(t[s]===r)return o[s]===e;s-=1}switch(n){case"Map":return r.size!==e.size?!1:Yt(r.entries(),e.entries(),t.concat([r]),o.concat([e]));case"Set":return r.size!==e.size?!1:Yt(r.values(),e.values(),t.concat([r]),o.concat([e]));case"Arguments":case"Array":case"Object":case"Boolean":case"Number":case"String":case"Date":case"Error":case"RegExp":case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"ArrayBuffer":break;default:return!1}var a=C(r);if(a.length!==C(e).length)return!1;var u=t.concat([r]),l=o.concat([e]);for(s=a.length-1;s>=0;){var c=a[s];if(!(z(c,e)&&Z(e[c],r[c],u,l)))return!1;s-=1}return!0}var ao=m(function(e,t){return Z(e,t,[],[])}),be=ao;function Ve(r,e,t){var o,n;if(typeof r.indexOf=="function")switch(typeof e){case"number":if(e===0){for(o=1/e;t<r.length;){if(n=r[t],n===0&&1/n===o)return t;t+=1}return-1}else if(e!==e){for(;t<r.length;){if(n=r[t],typeof n=="number"&&n!==n)return t;t+=1}return-1}return r.indexOf(e,t);case"string":case"boolean":case"function":case"undefined":return r.indexOf(e,t);case"object":if(e===null)return r.indexOf(e,t)}for(;t<r.length;){if(be(r[t],e))return t;t+=1}return-1}function He(r,e){return Ve(e,r,0)>=0}function O(r,e){for(var t=0,o=e.length,n=Array(o);t<o;)n[t]=r(e[t]),t+=1;return n}function Y(r){var e=r.replace(/\\/g,"\\\\").replace(/[\b]/g,"\\b").replace(/\f/g,"\\f").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t").replace(/\v/g,"\\v").replace(/\0/g,"\\0");return'"'+e.replace(/"/g,'\\"')+'"'}var ee=function(e){return(e<10?"0":"")+e},io=typeof Date.prototype.toISOString=="function"?function(e){return e.toISOString()}:function(e){return e.getUTCFullYear()+"-"+ee(e.getUTCMonth()+1)+"-"+ee(e.getUTCDate())+"T"+ee(e.getUTCHours())+":"+ee(e.getUTCMinutes())+":"+ee(e.getUTCSeconds())+"."+(e.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"},er=io;function Qe(r){return function(){return!r.apply(this,arguments)}}function te(r,e,t){for(var o=0,n=t.length;o<n;)e=r(e,t[o]),o+=1;return e}function Xe(r,e){for(var t=0,o=e.length,n=[];t<o;)r(e[t])&&(n[n.length]=e[t]),t+=1;return n}function Je(r){return Object.prototype.toString.call(r)==="[object Object]"}var uo=function(){function r(e,t){this.xf=t,this.f=e}return r.prototype["@@transducer/init"]=W.init,r.prototype["@@transducer/result"]=W.result,r.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.xf["@@transducer/step"](e,t):e},r}();function Ke(r){return function(e){return new uo(r,e)}}var lo=m(k(["fantasy-land/filter","filter"],Ke,function(r,e){return Je(e)?te(function(t,o){return r(e[o])&&(t[o]=e[o]),t},{},C(e)):Xe(r,e)})),tr=lo;var co=m(function(e,t){return tr(Qe(e),t)}),rr=co;function Le(r,e){var t=function(a){var u=e.concat([r]);return He(a,u)?"<Circular>":Le(a,u)},o=function(s,a){return O(function(u){return Y(u)+": "+t(s[u])},a.slice().sort())};switch(Object.prototype.toString.call(r)){case"[object Arguments]":return"(function() { return arguments; }("+O(t,r).join(", ")+"))";case"[object Array]":return"["+O(t,r).concat(o(r,rr(function(s){return/^\d+$/.test(s)},C(r)))).join(", ")+"]";case"[object Boolean]":return typeof r=="object"?"new Boolean("+t(r.valueOf())+")":r.toString();case"[object Date]":return"new Date("+(isNaN(r.valueOf())?t(NaN):Y(er(r)))+")";case"[object Map]":return"new Map("+t(Array.from(r))+")";case"[object Null]":return"null";case"[object Number]":return typeof r=="object"?"new Number("+t(r.valueOf())+")":1/r===-1/0?"-0":r.toString(10);case"[object Set]":return"new Set("+t(Array.from(r).sort())+")";case"[object String]":return typeof r=="object"?"new String("+t(r.valueOf())+")":Y(r);case"[object Undefined]":return"undefined";default:if(typeof r.toString=="function"){var n=r.toString();if(n!=="[object Object]")return n}return"{"+o(r,C(r)).join(", ")+"}"}}var fo=w(function(e){return Le(e,[])}),Ze=fo;var po=m(function(e,t){if(e===t)return t;function o(l,c){if(l>c!=c>l)return c>l?c:l}var n=o(e,t);if(n!==void 0)return n;var s=o(typeof e,typeof t);if(s!==void 0)return s===typeof e?e:t;var a=Ze(e),u=o(a,Ze(t));return u!==void 0&&u===a?e:t}),or=po;var mo=function(){function r(e,t){this.xf=t,this.f=e}return r.prototype["@@transducer/init"]=W.init,r.prototype["@@transducer/result"]=W.result,r.prototype["@@transducer/step"]=function(e,t){return this.xf["@@transducer/step"](e,this.f(t))},r}(),go=function(e){return function(t){return new mo(e,t)}},nr=go;var ho=m(k(["fantasy-land/map","map"],nr,function(e,t){switch(Object.prototype.toString.call(t)){case"[object Function]":return Ae(t.length,function(){return e.call(this,t.apply(this,arguments))});case"[object Object]":return te(function(o,n){return o[n]=e(t[n]),o},{},C(t));default:return O(e,t)}})),sr=ho;var Ee=Number.isInteger||function(e){return e<<0===e};function re(r){return Object.prototype.toString.call(r)==="[object String]"}function oe(r,e){var t=r<0?e.length+r:r;return re(e)?e.charAt(t):e[t]}var yo=m(function(e,t){if(t!=null)return Ee(e)?oe(e,t):t[e]}),q=yo;var xo=m(function(e,t){return sr(q(e),t)}),ar=xo;var wo=w(function(e){return H(e)?!0:!e||typeof e!="object"||re(e)?!1:e.length===0?!0:e.length>0?e.hasOwnProperty(0)&&e.hasOwnProperty(e.length-1):!1}),ir=wo;var ur=typeof Symbol<"u"?Symbol.iterator:"@@iterator";function Ye(r,e,t){return function(n,s,a){if(ir(a))return r(n,s,a);if(a==null)return s;if(typeof a["fantasy-land/reduce"]=="function")return e(n,s,a,"fantasy-land/reduce");if(a[ur]!=null)return t(n,s,a[ur]());if(typeof a.next=="function")return t(n,s,a);if(typeof a.reduce=="function")return e(n,s,a,"reduce");throw new TypeError("reduce: list must be array or iterable")}}function et(r,e,t){for(var o=0,n=t.length;o<n;){if(e=r["@@transducer/step"](e,t[o]),e&&e["@@transducer/reduced"]){e=e["@@transducer/value"];break}o+=1}return r["@@transducer/result"](e)}var vo=m(function(e,t){return D(e.length,function(){return e.apply(t,arguments)})}),lr=vo;function So(r,e,t){for(var o=t.next();!o.done;){if(e=r["@@transducer/step"](e,o.value),e&&e["@@transducer/reduced"]){e=e["@@transducer/value"];break}o=t.next()}return r["@@transducer/result"](e)}function _o(r,e,t,o){return r["@@transducer/result"](t[o](lr(r["@@transducer/step"],r),e))}var Ao=Ye(et,_o,So),cr=Ao;var Ro=function(){function r(e){this.f=e}return r.prototype["@@transducer/init"]=function(){throw new Error("init not implemented on XWrap")},r.prototype["@@transducer/result"]=function(e){return e},r.prototype["@@transducer/step"]=function(e,t){return this.f(e,t)},r}();function tt(r){return new Ro(r)}var To=N(function(r,e,t){return cr(typeof r=="function"?tt(r):r,e,t)}),Ie=To;function rt(r,e){return function(){return e.call(this,r.apply(this,arguments))}}function ne(r,e){return function(){var t=arguments.length;if(t===0)return e();var o=arguments[t-1];return H(o)||typeof o[r]!="function"?e.apply(this,arguments):o[r].apply(o,Array.prototype.slice.call(arguments,0,t-1))}}var Mo=N(ne("slice",function(e,t,o){return Array.prototype.slice.call(o,e,t)})),fr=Mo;var bo=w(ne("tail",fr(1,1/0))),pr=bo;function se(){if(arguments.length===0)throw new Error("pipe requires at least one argument");return D(arguments[0].length,Ie(rt,arguments[0],pr(arguments)))}var Lo=m(function(e,t){return Ae(Ie(or,0,ar("length",t)),function(){var o=arguments,n=this;return e.apply(n,O(function(s){return s.apply(n,o)},t))})}),mr=Lo;var Eo=m(function(e,t){return t==null||t!==t?e:t}),ae=Eo;var Io=function(){function r(e,t){this.xf=t,this.f=e,this.found=!1}return r.prototype["@@transducer/init"]=W.init,r.prototype["@@transducer/result"]=function(e){return this.found||(e=this.xf["@@transducer/step"](e,void 0)),this.xf["@@transducer/result"](e)},r.prototype["@@transducer/step"]=function(e,t){return this.f(t)&&(this.found=!0,e=ke(this.xf["@@transducer/step"](e,t))),e},r}();function ot(r){return function(e){return new Io(r,e)}}var Po=m(k(["find"],ot,function(e,t){for(var o=0,n=t.length;o<n;){if(e(t[o]))return t[o];o+=1}})),nt=Po;var Uo=w(function(e){return mr(function(){return Array.prototype.slice.call(arguments,0)},e)}),st=Uo;function at(r,e){for(var t=e,o=0;o<r.length;o+=1){if(t==null)return;var n=r[o];Ee(n)?t=oe(n,t):t=t[n]}return t}var Fo=m(at),Pe=Fo;var Co=N(function(e,t,o){return be(e,q(t,o))}),it=Co;var Q=typeof performance=="object"&&performance&&typeof performance.now=="function"?performance:Date,dr=new Set,ut=typeof process=="object"&&process?process:{},hr=(r,e,t,o)=>{typeof ut.emitWarning=="function"?ut.emitWarning(r,e,t,o):console.error(`[${t}] ${e}: ${r}`)},Ue=globalThis.AbortController,gr=globalThis.AbortSignal;if(typeof Ue>"u"){gr=class{onabort;_onabort=[];reason;aborted=!1;addEventListener(o,n){this._onabort.push(n)}},Ue=class{constructor(){e()}signal=new gr;abort(o){if(!this.signal.aborted){this.signal.reason=o,this.signal.aborted=!0;for(let n of this.signal._onabort)n(o);this.signal.onabort?.(o)}}};let r=ut.env?.LRU_CACHE_IGNORE_AC_WARNING!=="1",e=()=>{r&&(r=!1,hr("AbortController is not defined. If using lru-cache in node 14, load an AbortController polyfill from the `node-abort-controller` package. A minimal polyfill is provided for use by LRUCache.fetch(), but it should not be relied upon in other contexts (eg, passing it to other APIs that use AbortController/AbortSignal might have undesirable effects). You may disable this with LRU_CACHE_IGNORE_AC_WARNING=1 in the env.","NO_ABORT_CONTROLLER","ENOTSUP",e))}}var Do=r=>!dr.has(r),Hu=Symbol("type"),G=r=>r&&r===Math.floor(r)&&r>0&&isFinite(r),yr=r=>G(r)?r<=Math.pow(2,8)?Uint8Array:r<=Math.pow(2,16)?Uint16Array:r<=Math.pow(2,32)?Uint32Array:r<=Number.MAX_SAFE_INTEGER?X:null:null,X=class extends Array{constructor(e){super(e),this.fill(0)}},lt=class r{heap;length;static#u=!1;static create(e){let t=yr(e);if(!t)return[];r.#u=!0;let o=new r(e,t);return r.#u=!1,o}constructor(e,t){if(!r.#u)throw new TypeError("instantiate Stack using Stack.create(n)");this.heap=new t(e),this.length=0}push(e){this.heap[this.length++]=e}pop(){return this.heap[--this.length]}},Fe=class r{#u;#f;#d;#h;#E;ttl;ttlResolution;ttlAutopurge;updateAgeOnGet;updateAgeOnHas;allowStale;noDisposeOnSet;noUpdateTTL;maxEntrySize;sizeCalculation;noDeleteOnFetchRejection;noDeleteOnStaleGet;allowStaleOnFetchAbort;allowStaleOnFetchRejection;ignoreFetchAbort;#n;#y;#o;#r;#e;#l;#p;#i;#s;#x;#a;#w;#v;#m;#S;#T;#c;static unsafeExposeInternals(e){return{starts:e.#v,ttls:e.#m,sizes:e.#w,keyMap:e.#o,keyList:e.#r,valList:e.#e,next:e.#l,prev:e.#p,get head(){return e.#i},get tail(){return e.#s},free:e.#x,isBackgroundFetch:t=>e.#t(t),backgroundFetch:(t,o,n,s)=>e.#U(t,o,n,s),moveToTail:t=>e.#L(t),indexes:t=>e.#_(t),rindexes:t=>e.#A(t),isStale:t=>e.#g(t)}}get max(){return this.#u}get maxSize(){return this.#f}get calculatedSize(){return this.#y}get size(){return this.#n}get fetchMethod(){return this.#E}get dispose(){return this.#d}get disposeAfter(){return this.#h}constructor(e){let{max:t=0,ttl:o,ttlResolution:n=1,ttlAutopurge:s,updateAgeOnGet:a,updateAgeOnHas:u,allowStale:l,dispose:c,disposeAfter:f,noDisposeOnSet:p,noUpdateTTL:d,maxSize:x=0,maxEntrySize:M=0,sizeCalculation:v,fetchMethod:T,noDeleteOnFetchRejection:h,noDeleteOnStaleGet:A,allowStaleOnFetchRejection:L,allowStaleOnFetchAbort:S,ignoreFetchAbort:b}=e;if(t!==0&&!G(t))throw new TypeError("max option must be a nonnegative integer");let U=t?yr(t):Array;if(!U)throw new Error("invalid max value: "+t);if(this.#u=t,this.#f=x,this.maxEntrySize=M||this.#f,this.sizeCalculation=v,this.sizeCalculation){if(!this.#f&&!this.maxEntrySize)throw new TypeError("cannot set sizeCalculation without setting maxSize or maxEntrySize");if(typeof this.sizeCalculation!="function")throw new TypeError("sizeCalculation set to non-function")}if(T!==void 0&&typeof T!="function")throw new TypeError("fetchMethod must be a function if specified");if(this.#E=T,this.#T=!!T,this.#o=new Map,this.#r=new Array(t).fill(void 0),this.#e=new Array(t).fill(void 0),this.#l=new U(t),this.#p=new U(t),this.#i=0,this.#s=0,this.#x=lt.create(t),this.#n=0,this.#y=0,typeof c=="function"&&(this.#d=c),typeof f=="function"?(this.#h=f,this.#a=[]):(this.#h=void 0,this.#a=void 0),this.#S=!!this.#d,this.#c=!!this.#h,this.noDisposeOnSet=!!p,this.noUpdateTTL=!!d,this.noDeleteOnFetchRejection=!!h,this.allowStaleOnFetchRejection=!!L,this.allowStaleOnFetchAbort=!!S,this.ignoreFetchAbort=!!b,this.maxEntrySize!==0){if(this.#f!==0&&!G(this.#f))throw new TypeError("maxSize must be a positive integer if specified");if(!G(this.maxEntrySize))throw new TypeError("maxEntrySize must be a positive integer if specified");this.#W()}if(this.allowStale=!!l,this.noDeleteOnStaleGet=!!A,this.updateAgeOnGet=!!a,this.updateAgeOnHas=!!u,this.ttlResolution=G(n)||n===0?n:1,this.ttlAutopurge=!!s,this.ttl=o||0,this.ttl){if(!G(this.ttl))throw new TypeError("ttl must be a positive integer if specified");this.#F()}if(this.#u===0&&this.ttl===0&&this.#f===0)throw new TypeError("At least one of max, maxSize, or ttl is required");if(!this.ttlAutopurge&&!this.#u&&!this.#f){let E="LRU_CACHE_UNBOUNDED";Do(E)&&(dr.add(E),hr("TTL caching without ttlAutopurge, max, or maxSize can result in unbounded memory consumption.","UnboundedCacheWarning",E,r))}}getRemainingTTL(e){return this.#o.has(e)?1/0:0}#F(){let e=new X(this.#u),t=new X(this.#u);this.#m=e,this.#v=t,this.#C=(s,a,u=Q.now())=>{if(t[s]=a!==0?u:0,e[s]=a,a!==0&&this.ttlAutopurge){let l=setTimeout(()=>{this.#g(s)&&this.delete(this.#r[s])},a+1);l.unref&&l.unref()}},this.#M=s=>{t[s]=e[s]!==0?Q.now():0},this.#R=(s,a)=>{if(e[a]){let u=e[a],l=t[a];if(!u||!l)return;s.ttl=u,s.start=l,s.now=o||n();let c=s.now-l;s.remainingTTL=u-c}};let o=0,n=()=>{let s=Q.now();if(this.ttlResolution>0){o=s;let a=setTimeout(()=>o=0,this.ttlResolution);a.unref&&a.unref()}return s};this.getRemainingTTL=s=>{let a=this.#o.get(s);if(a===void 0)return 0;let u=e[a],l=t[a];if(!u||!l)return 1/0;let c=(o||n())-l;return u-c},this.#g=s=>{let a=t[s],u=e[s];return!!u&&!!a&&(o||n())-a>u}}#M=()=>{};#R=()=>{};#C=()=>{};#g=()=>!1;#W(){let e=new X(this.#u);this.#y=0,this.#w=e,this.#b=t=>{this.#y-=e[t],e[t]=0},this.#D=(t,o,n,s)=>{if(this.#t(o))return 0;if(!G(n))if(s){if(typeof s!="function")throw new TypeError("sizeCalculation must be a function");if(n=s(o,t),!G(n))throw new TypeError("sizeCalculation return invalid (expect positive integer)")}else throw new TypeError("invalid size value (must be positive integer). When maxSize or maxEntrySize is used, sizeCalculation or size must be set.");return n},this.#I=(t,o,n)=>{if(e[t]=o,this.#f){let s=this.#f-e[t];for(;this.#y>s;)this.#P(!0)}this.#y+=e[t],n&&(n.entrySize=o,n.totalCalculatedSize=this.#y)}}#b=e=>{};#I=(e,t,o)=>{};#D=(e,t,o,n)=>{if(o||n)throw new TypeError("cannot set size without setting maxSize or maxEntrySize on cache");return 0};*#_({allowStale:e=this.allowStale}={}){if(this.#n)for(let t=this.#s;!(!this.#O(t)||((e||!this.#g(t))&&(yield t),t===this.#i));)t=this.#p[t]}*#A({allowStale:e=this.allowStale}={}){if(this.#n)for(let t=this.#i;!(!this.#O(t)||((e||!this.#g(t))&&(yield t),t===this.#s));)t=this.#l[t]}#O(e){return e!==void 0&&this.#o.get(this.#r[e])===e}*entries(){for(let e of this.#_())this.#e[e]!==void 0&&this.#r[e]!==void 0&&!this.#t(this.#e[e])&&(yield[this.#r[e],this.#e[e]])}*rentries(){for(let e of this.#A())this.#e[e]!==void 0&&this.#r[e]!==void 0&&!this.#t(this.#e[e])&&(yield[this.#r[e],this.#e[e]])}*keys(){for(let e of this.#_()){let t=this.#r[e];t!==void 0&&!this.#t(this.#e[e])&&(yield t)}}*rkeys(){for(let e of this.#A()){let t=this.#r[e];t!==void 0&&!this.#t(this.#e[e])&&(yield t)}}*values(){for(let e of this.#_())this.#e[e]!==void 0&&!this.#t(this.#e[e])&&(yield this.#e[e])}*rvalues(){for(let e of this.#A())this.#e[e]!==void 0&&!this.#t(this.#e[e])&&(yield this.#e[e])}[Symbol.iterator](){return this.entries()}[Symbol.toStringTag]="LRUCache";find(e,t={}){for(let o of this.#_()){let n=this.#e[o],s=this.#t(n)?n.__staleWhileFetching:n;if(s!==void 0&&e(s,this.#r[o],this))return this.get(this.#r[o],t)}}forEach(e,t=this){for(let o of this.#_()){let n=this.#e[o],s=this.#t(n)?n.__staleWhileFetching:n;s!==void 0&&e.call(t,s,this.#r[o],this)}}rforEach(e,t=this){for(let o of this.#A()){let n=this.#e[o],s=this.#t(n)?n.__staleWhileFetching:n;s!==void 0&&e.call(t,s,this.#r[o],this)}}purgeStale(){let e=!1;for(let t of this.#A({allowStale:!0}))this.#g(t)&&(this.delete(this.#r[t]),e=!0);return e}info(e){let t=this.#o.get(e);if(t===void 0)return;let o=this.#e[t],n=this.#t(o)?o.__staleWhileFetching:o;if(n===void 0)return;let s={value:n};if(this.#m&&this.#v){let a=this.#m[t],u=this.#v[t];if(a&&u){let l=a-(Q.now()-u);s.ttl=l,s.start=Date.now()}}return this.#w&&(s.size=this.#w[t]),s}dump(){let e=[];for(let t of this.#_({allowStale:!0})){let o=this.#r[t],n=this.#e[t],s=this.#t(n)?n.__staleWhileFetching:n;if(s===void 0||o===void 0)continue;let a={value:s};if(this.#m&&this.#v){a.ttl=this.#m[t];let u=Q.now()-this.#v[t];a.start=Math.floor(Date.now()-u)}this.#w&&(a.size=this.#w[t]),e.unshift([o,a])}return e}load(e){this.clear();for(let[t,o]of e){if(o.start){let n=Date.now()-o.start;o.start=Q.now()-n}this.set(t,o.value,o)}}set(e,t,o={}){if(t===void 0)return this.delete(e),this;let{ttl:n=this.ttl,start:s,noDisposeOnSet:a=this.noDisposeOnSet,sizeCalculation:u=this.sizeCalculation,status:l}=o,{noUpdateTTL:c=this.noUpdateTTL}=o,f=this.#D(e,t,o.size||0,u);if(this.maxEntrySize&&f>this.maxEntrySize)return l&&(l.set="miss",l.maxEntrySizeExceeded=!0),this.delete(e),this;let p=this.#n===0?void 0:this.#o.get(e);if(p===void 0)p=this.#n===0?this.#s:this.#x.length!==0?this.#x.pop():this.#n===this.#u?this.#P(!1):this.#n,this.#r[p]=e,this.#e[p]=t,this.#o.set(e,p),this.#l[this.#s]=p,this.#p[p]=this.#s,this.#s=p,this.#n++,this.#I(p,f,l),l&&(l.set="add"),c=!1;else{this.#L(p);let d=this.#e[p];if(t!==d){if(this.#T&&this.#t(d)){d.__abortController.abort(new Error("replaced"));let{__staleWhileFetching:x}=d;x!==void 0&&!a&&(this.#S&&this.#d?.(x,e,"set"),this.#c&&this.#a?.push([x,e,"set"]))}else a||(this.#S&&this.#d?.(d,e,"set"),this.#c&&this.#a?.push([d,e,"set"]));if(this.#b(p),this.#I(p,f,l),this.#e[p]=t,l){l.set="replace";let x=d&&this.#t(d)?d.__staleWhileFetching:d;x!==void 0&&(l.oldValue=x)}}else l&&(l.set="update")}if(n!==0&&!this.#m&&this.#F(),this.#m&&(c||this.#C(p,n,s),l&&this.#R(l,p)),!a&&this.#c&&this.#a){let d=this.#a,x;for(;x=d?.shift();)this.#h?.(...x)}return this}pop(){try{for(;this.#n;){let e=this.#e[this.#i];if(this.#P(!0),this.#t(e)){if(e.__staleWhileFetching)return e.__staleWhileFetching}else if(e!==void 0)return e}}finally{if(this.#c&&this.#a){let e=this.#a,t;for(;t=e?.shift();)this.#h?.(...t)}}}#P(e){let t=this.#i,o=this.#r[t],n=this.#e[t];return this.#T&&this.#t(n)?n.__abortController.abort(new Error("evicted")):(this.#S||this.#c)&&(this.#S&&this.#d?.(n,o,"evict"),this.#c&&this.#a?.push([n,o,"evict"])),this.#b(t),e&&(this.#r[t]=void 0,this.#e[t]=void 0,this.#x.push(t)),this.#n===1?(this.#i=this.#s=0,this.#x.length=0):this.#i=this.#l[t],this.#o.delete(o),this.#n--,t}has(e,t={}){let{updateAgeOnHas:o=this.updateAgeOnHas,status:n}=t,s=this.#o.get(e);if(s!==void 0){let a=this.#e[s];if(this.#t(a)&&a.__staleWhileFetching===void 0)return!1;if(this.#g(s))n&&(n.has="stale",this.#R(n,s));else return o&&this.#M(s),n&&(n.has="hit",this.#R(n,s)),!0}else n&&(n.has="miss");return!1}peek(e,t={}){let{allowStale:o=this.allowStale}=t,n=this.#o.get(e);if(n===void 0||!o&&this.#g(n))return;let s=this.#e[n];return this.#t(s)?s.__staleWhileFetching:s}#U(e,t,o,n){let s=t===void 0?void 0:this.#e[t];if(this.#t(s))return s;let a=new Ue,{signal:u}=o;u?.addEventListener("abort",()=>a.abort(u.reason),{signal:a.signal});let l={signal:a.signal,options:o,context:n},c=(v,T=!1)=>{let{aborted:h}=a.signal,A=o.ignoreFetchAbort&&v!==void 0;if(o.status&&(h&&!T?(o.status.fetchAborted=!0,o.status.fetchError=a.signal.reason,A&&(o.status.fetchAbortIgnored=!0)):o.status.fetchResolved=!0),h&&!A&&!T)return p(a.signal.reason);let L=x;return this.#e[t]===x&&(v===void 0?L.__staleWhileFetching?this.#e[t]=L.__staleWhileFetching:this.delete(e):(o.status&&(o.status.fetchUpdated=!0),this.set(e,v,l.options))),v},f=v=>(o.status&&(o.status.fetchRejected=!0,o.status.fetchError=v),p(v)),p=v=>{let{aborted:T}=a.signal,h=T&&o.allowStaleOnFetchAbort,A=h||o.allowStaleOnFetchRejection,L=A||o.noDeleteOnFetchRejection,S=x;if(this.#e[t]===x&&(!L||S.__staleWhileFetching===void 0?this.delete(e):h||(this.#e[t]=S.__staleWhileFetching)),A)return o.status&&S.__staleWhileFetching!==void 0&&(o.status.returnedStale=!0),S.__staleWhileFetching;if(S.__returned===S)throw v},d=(v,T)=>{let h=this.#E?.(e,s,l);h&&h instanceof Promise&&h.then(A=>v(A===void 0?void 0:A),T),a.signal.addEventListener("abort",()=>{(!o.ignoreFetchAbort||o.allowStaleOnFetchAbort)&&(v(void 0),o.allowStaleOnFetchAbort&&(v=A=>c(A,!0)))})};o.status&&(o.status.fetchDispatched=!0);let x=new Promise(d).then(c,f),M=Object.assign(x,{__abortController:a,__staleWhileFetching:s,__returned:void 0});return t===void 0?(this.set(e,M,{...l.options,status:void 0}),t=this.#o.get(e)):this.#e[t]=M,M}#t(e){if(!this.#T)return!1;let t=e;return!!t&&t instanceof Promise&&t.hasOwnProperty("__staleWhileFetching")&&t.__abortController instanceof Ue}async fetch(e,t={}){let{allowStale:o=this.allowStale,updateAgeOnGet:n=this.updateAgeOnGet,noDeleteOnStaleGet:s=this.noDeleteOnStaleGet,ttl:a=this.ttl,noDisposeOnSet:u=this.noDisposeOnSet,size:l=0,sizeCalculation:c=this.sizeCalculation,noUpdateTTL:f=this.noUpdateTTL,noDeleteOnFetchRejection:p=this.noDeleteOnFetchRejection,allowStaleOnFetchRejection:d=this.allowStaleOnFetchRejection,ignoreFetchAbort:x=this.ignoreFetchAbort,allowStaleOnFetchAbort:M=this.allowStaleOnFetchAbort,context:v,forceRefresh:T=!1,status:h,signal:A}=t;if(!this.#T)return h&&(h.fetch="get"),this.get(e,{allowStale:o,updateAgeOnGet:n,noDeleteOnStaleGet:s,status:h});let L={allowStale:o,updateAgeOnGet:n,noDeleteOnStaleGet:s,ttl:a,noDisposeOnSet:u,size:l,sizeCalculation:c,noUpdateTTL:f,noDeleteOnFetchRejection:p,allowStaleOnFetchRejection:d,allowStaleOnFetchAbort:M,ignoreFetchAbort:x,status:h,signal:A},S=this.#o.get(e);if(S===void 0){h&&(h.fetch="miss");let b=this.#U(e,S,L,v);return b.__returned=b}else{let b=this.#e[S];if(this.#t(b)){let K=o&&b.__staleWhileFetching!==void 0;return h&&(h.fetch="inflight",K&&(h.returnedStale=!0)),K?b.__staleWhileFetching:b.__returned=b}let U=this.#g(S);if(!T&&!U)return h&&(h.fetch="hit"),this.#L(S),n&&this.#M(S),h&&this.#R(h,S),b;let E=this.#U(e,S,L,v),J=E.__staleWhileFetching!==void 0&&o;return h&&(h.fetch=U?"stale":"refresh",J&&U&&(h.returnedStale=!0)),J?E.__staleWhileFetching:E.__returned=E}}get(e,t={}){let{allowStale:o=this.allowStale,updateAgeOnGet:n=this.updateAgeOnGet,noDeleteOnStaleGet:s=this.noDeleteOnStaleGet,status:a}=t,u=this.#o.get(e);if(u!==void 0){let l=this.#e[u],c=this.#t(l);return a&&this.#R(a,u),this.#g(u)?(a&&(a.get="stale"),c?(a&&o&&l.__staleWhileFetching!==void 0&&(a.returnedStale=!0),o?l.__staleWhileFetching:void 0):(s||this.delete(e),a&&o&&(a.returnedStale=!0),o?l:void 0)):(a&&(a.get="hit"),c?l.__staleWhileFetching:(this.#L(u),n&&this.#M(u),l))}else a&&(a.get="miss")}#j(e,t){this.#p[t]=e,this.#l[e]=t}#L(e){e!==this.#s&&(e===this.#i?this.#i=this.#l[e]:this.#j(this.#p[e],this.#l[e]),this.#j(this.#s,e),this.#s=e)}delete(e){let t=!1;if(this.#n!==0){let o=this.#o.get(e);if(o!==void 0)if(t=!0,this.#n===1)this.clear();else{this.#b(o);let n=this.#e[o];if(this.#t(n)?n.__abortController.abort(new Error("deleted")):(this.#S||this.#c)&&(this.#S&&this.#d?.(n,e,"delete"),this.#c&&this.#a?.push([n,e,"delete"])),this.#o.delete(e),this.#r[o]=void 0,this.#e[o]=void 0,o===this.#s)this.#s=this.#p[o];else if(o===this.#i)this.#i=this.#l[o];else{let s=this.#p[o];this.#l[s]=this.#l[o];let a=this.#l[o];this.#p[a]=this.#p[o]}this.#n--,this.#x.push(o)}}if(this.#c&&this.#a?.length){let o=this.#a,n;for(;n=o?.shift();)this.#h?.(...n)}return t}clear(){for(let e of this.#A({allowStale:!0})){let t=this.#e[e];if(this.#t(t))t.__abortController.abort(new Error("deleted"));else{let o=this.#r[e];this.#S&&this.#d?.(t,o,"delete"),this.#c&&this.#a?.push([t,o,"delete"])}}if(this.#o.clear(),this.#e.fill(void 0),this.#r.fill(void 0),this.#m&&this.#v&&(this.#m.fill(0),this.#v.fill(0)),this.#w&&this.#w.fill(0),this.#i=0,this.#s=0,this.#x.length=0,this.#y=0,this.#n=0,this.#c&&this.#a){let e=this.#a,t;for(;t=e?.shift();)this.#h?.(...t)}}};var g=require("zod"),Ce=class extends Error{name="InvalidSchedulerLocation"},Oo=class extends Error{name="SchedulerTagNotFound"},jo=class extends Error{name="TransactionNotFound"},Wo="Url",zo="Time-To-Live",qo="Scheduler",ct=r=>se(ae([]),nt(it(r,"name")),ae({}),q("value")),xr=r=>se(e=>{if(!e)throw new jo(r);return e},q("tags"),ae([]));function wr({fetch:r,GRAPHQL_URL:e}){return async({query:t,variables:o})=>r(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:t,variables:o})}).then(n=>n.json())}function Go({fetch:r,GRAPHQL_URL:e}){let t=wr({fetch:r,GRAPHQL_URL:e}),o=vr({fetch:r,GRAPHQL_URL:e}),n=`
    query GetTransactions ($transactionIds: [ID!]!) {
      transactions(ids: $transactionIds) {
        edges {
          node {
            tags {
              name
              value
            }
          }
        }
      }
    }
  `;return async s=>t({query:n,variables:{transactionIds:[s]}}).then(Pe(["data","transactions","edges","0","node"])).then(xr(`Process ${s} was not found on gateway`)).then(ct(qo)).then(a=>{if(!a)throw new Oo('No "Scheduler" tag found on process');return o(a)})}function vr({fetch:r,GRAPHQL_URL:e}){let t=wr({fetch:r,GRAPHQL_URL:e}),o=`
    query GetSchedulerLocation ($owner: String!) {
      transactions (
        owners: [$owner]
        tags: [
          { name: "Data-Protocol", values: ["ao"] },
          { name: "Type", values: ["Scheduler-Location"] }
        ]
        # Only need the most recent Scheduler-Location
        sort: HEIGHT_DESC
        first: 1
      ) {
        edges {
          node {
            tags {
              name
              value
            }
          }
        }
      }
    }
  `;return async n=>t({query:o,variables:{owner:n}}).then(Pe(["data","transactions","edges","0","node"])).then(xr(`Could not find 'Scheduler-Location' owner by wallet ${n}`)).then(st([ct(Wo),ct(zo)])).then(([s,a])=>{if(!s)throw new Ce('No "Url" tag found on Scheduler-Location');if(!a)throw new Ce('No "Time-To-Live" tag found on Scheduler-Location');return{url:s,ttl:a,address:n}})}function No({size:r}){return new Fe({max:r,maxSize:5e6,sizeCalculation:t=>JSON.stringify(t).length,allowStale:!0})}function ko({cache:r}){return async e=>{if(r.max)return r.get(e)}}function Bo({cache:r}){return async(e,{url:t,address:o},n)=>{if(r.max)return r.set(e,{url:t,address:o},{ttl:n})}}function $o({cache:r}){return async e=>{if(r.max)return r.get(e)}}function Vo({cache:r}){return async(e,t,o)=>{if(r.max)return r.set(e,{url:t,address:e,ttl:o},{ttl:o})}}function Ho({fetch:r}){return async(e,t)=>{let o=await r(`${e}?process-id=${t}`,{method:"GET",redirect:"manual"});return[301,302,307,308].includes(o.status)?new URL(o.headers.get("Location")).origin:e}}var Sr=g.z.object({url:g.z.string(),address:g.z.string()}),_r=g.z.object({url:g.z.string(),address:g.z.string(),ttl:g.z.coerce.number()}),Qo=g.z.function().args(g.z.string(),g.z.string()).returns(g.z.promise(g.z.string())),Xo=g.z.function().args(g.z.string()).returns(g.z.promise(Sr.nullish())),Jo=g.z.function().args(g.z.string(),Sr,g.z.number()).returns(g.z.promise(g.z.any())),ft=g.z.function().args(g.z.string()).returns(g.z.promise(_r.nullish())),pt=g.z.function().args(g.z.string(),g.z.string(),g.z.number()).returns(g.z.promise(g.z.any())),De=g.z.function().args(g.z.string()).returns(g.z.promise(_r)),Ko=De;function Zo({loadProcessScheduler:r,loadScheduler:e,cache:t,followRedirects:o,checkForRedirect:n}){r=Ko.implement(r),e=De.implement(e),n=Qo.implement(n);let s=Xo.implement(t.getByProcess),a=ft.implement(t.getByOwner),u=Jo.implement(t.setByProcess),l=pt.implement(t.setByOwner);return(c,f)=>s(c).then(async p=>p||Promise.resolve().then(async()=>{if(f){let d=await a(f);return d||e(f).then(x=>(l(x.address,x.url,x.ttl),x))}return r(c)}).then(async d=>{let x=d.url;o&&(x=await n(d.url,c));let M={url:x,address:d.address};return await u(c,M,d.ttl),M}))}function Yo({loadScheduler:r,cache:e}){r=De.implement(r);let t=ft.implement(e.getByOwner),o=pt.implement(e.setByOwner);return n=>t(n).then(s=>s?{url:s.url}:r(n).then(a=>o(n,a.url,a.ttl).then(()=>({url:a.url}))).catch(a=>{if(!(a instanceof Ce))throw a}))}function en({loadScheduler:r,cache:e}){r=De.implement(r);let t=ft.implement(e.getByOwner),o=pt.implement(e.setByOwner);return n=>t(n).then(s=>s?!0:r(n).then(a=>o(n,a.url,a.ttl)).then(()=>!0).catch(a=>{if(a instanceof Ce)return!1;throw a}))}var tn="https://arweave.net/graphql";function mt({cacheSize:r=100,GRAPHQL_URL:e=tn,followRedirects:t=!1}={}){let o=No({size:r}),n=vr({fetch,GRAPHQL_URL:e}),s={getByProcess:ko({cache:o}),getByOwner:$o({cache:o}),setByProcess:Bo({cache:o}),setByOwner:Vo({cache:o})},a=Zo({loadProcessScheduler:Go({fetch,GRAPHQL_URL:e}),loadScheduler:n,cache:s,followRedirects:t,checkForRedirect:Ho({fetch})}),u=en({loadScheduler:n,cache:s}),l=Yo({loadScheduler:n,cache:s});return{locate:a,validate:u,raw:l}}var rn=process.env.GRAPHQL_URL||void 0,on=process.env.SCHEDULER_UTILS_CACHE_SIZE||void 0,nn=process.env.SCHEDULER_UTILS_FOLLOW_REDIRECTS==="true"||void 0,{locate:Ku,validate:Zu,raw:Yu}=mt({GRAPHQL_URL:rn,cacheSize:on,followRedirects:nn});function gt(r){function e(s){if(typeof s!="string")throw new Error("Encountered Error serializing cron: invalid interval");let[a,u]=s.split("-").map(d=>d.trim());if(!a||!u)throw new Error("Encountered Error serializing cron: invalid interval");if(!parseInt(a)||parseInt(a)<0)throw new Error("Encountered Error serializing cron: invalid interval value");let l=/^(millisecond|second|minute|hour|day|month|year|block)$/,c=/^(milliseconds|seconds|minutes|hours|days|months|years|blocks)$/,f=u.match(l),p=u.match(c);if(parseInt(a)>1&&!p||parseInt(a)===1&&!f)throw new Error("Encountered Error serializing cron: invalid interval type");return`${a}-${u}`}function t(s=[]){return s.map(a=>{if(!a.name||!a.value)throw new Error("Encountered Error serializing cron: invalid tag structure");if(typeof a.name!="string"||typeof a.value!="string")throw new Error("Encountered Error serializing cron: invalid interval tag types");return{name:`Cron-Tag-${a.name}`,value:a.value}})}let o=e(r.interval),n=t(r.tags);return[{name:"Cron-Interval",value:o},...n]}var sn="https://arweave.net",an="https://mu.ao-testnet.xyz",un="https://cu.ao-testnet.xyz";function dt({GRAPHQL_URL:r="",GATEWAY_URL:e=sn,MU_URL:t=an,CU_URL:o=un}){console.log(JSON.stringify({CU_URL:o,MU_URL:t,GATEWAY_URL:e,GRAPHQL_URL:r}));let n=qe();r||(r=_t({url:e,path:"/graphql"}));let{validate:s}=mt({cacheSize:100,GRAPHQL_URL:r}),a=St({MAX_SIZE:25}),u=n.child("result"),l=new de({fetch,CU_URL:o,logger:u}),c=Ut({loadResult:l.execute.bind(l),logger:u}),f=n.child("message"),p=new B({fetch,cache:a,logger:f}),d=new le({fetch,MU_URL:t,logger:f}),x=Dt({loadProcessMeta:p.execute.bind(p),deployMessage:d.execute.bind(d),logger:f}),M=n.child("spawn"),v=new we({fetch,GRAPHQL_URL:r,logger:M}),T=new ce({fetch,MU_URL:t,logger:M}),h=Wt({loadTransactionMeta:v.execute.bind(v),validateScheduler:s,deployProcess:T.execute.bind(T),logger:M}),A=n.child("monitor"),L=new B({fetch,cache:a,logger:A}),S=new fe({fetch,MU_URL:t,logger:A}),b=qt({loadProcessMeta:L.execute.bind(L),deployMonitor:S.execute.bind(S),logger:A}),U=n.child("unmonitor"),E=new B({fetch,cache:a,logger:U}),je=Nt({loadProcessMeta:E.execute.bind(E),deployUnmonitor:new pe({fetch,MU_URL:t,logger:U}).execute,logger:A}),J=n.child("results"),K=new he({fetch,CU_URL:o,logger:J}),Tr=Qt({queryResults:K.execute.bind(K),logger:J}),ht=n.child("dryrun"),yt=new ge({fetch,CU_URL:o,logger:ht}),Mr=Bt({dryrunFetch:yt.execute.bind(yt),logger:ht}),br=n.child("assign"),xt=new me({fetch,MU_URL:t,logger:br}),Lr=Vt({deployAssign:xt.execute.bind(xt),logger:f});return{result:c,results:Tr,message:x,spawn:h,monitor:b,unmonitor:je,dryrun:Mr,assign:Lr}}var Oe={};wt(Oe,{createDataItemSigner:()=>pn});var wl=ue(Rr(),1),ln=ue(require("warp-arbundles"),1),{createData:cn,ArweaveSigner:fn}=ln;function pn(r){return async({data:e,tags:t,target:o,anchor:n})=>{let s=new fn(r),a=cn(e,s,{tags:t,target:o,anchor:n});return await a.sign(s),{id:await a.id,raw:await a.getRaw()}}}var mn=process.env.GATEWAY_URL||void 0,gn=process.env.MU_URL||void 0,dn=process.env.CU_URL||void 0,hn=process.env.GRAPHQL_URL||void 0,{result:yn,results:xn,message:wn,spawn:vn,monitor:Sn,unmonitor:_n,dryrun:An,assign:Rn}=dt({GATEWAY_URL:mn,MU_URL:gn,CU_URL:dn,GRAPHQL_URL:hn});var Tn=Oe.createDataItemSigner;0&&(module.exports={assign,connect,createDataItemSigner,dryrun,message,monitor,result,results,serializeCron,spawn,unmonitor});
